@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>&#x1F393;</text></svg>">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Reports - Attendance Management System</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="~/css/neo-brutalist.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container { position: relative; height: 300px; margin-top: 20px; }
        .tab-buttons { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn {
            padding: 12px 20px;
            font-family: var(--font-display);
            font-weight: 700;
            font-size: 14px;
            border: 3px solid #000;
            box-shadow: 4px 4px 0px #000;
            cursor: pointer;
            transition: all 0.1s ease;
            background: var(--bg-cream);
            color: #000;
        }
        .tab-btn:hover { transform: translate(-2px, -2px); box-shadow: 6px 6px 0px #000; }
        .tab-btn.active { background: #9333ea; color: white; }
        .filter-row { display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap; }
        .filter-group { flex: 1; min-width: 200px; }
        .filter-section { display: none; gap: 20px; flex: 1; }
        .filter-section.active { display: flex; }
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 25px; }
        @@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-spinner { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <div class="neo-container">
        <aside class="neo-sidebar">
            <div class="neo-sidebar-header">
                <h2>AMS Admin</h2>
                <p>// Reports & Analytics</p>
            </div>
            <nav class="neo-sidebar-menu">
                <a href="/Admin/Dashboard" class="neo-menu-item"><i class="fas fa-home"></i><span>Dashboard</span></a>
                <a href="/Admin/Students" class="neo-menu-item"><i class="fas fa-user-graduate"></i><span>Students</span></a>
                <a href="/Admin/Teachers" class="neo-menu-item"><i class="fas fa-chalkboard-teacher"></i><span>Teachers</span></a>
                <a href="/Admin/Courses" class="neo-menu-item"><i class="fas fa-book"></i><span>Courses</span></a>
                <a href="/Admin/Sessions" class="neo-menu-item"><i class="fas fa-calendar-alt"></i><span>Sessions</span></a>
                <a href="/Admin/Reports" class="neo-menu-item active"><i class="fas fa-chart-bar"></i><span>Reports</span></a>
                <a href="/Account/Logout" class="neo-menu-item"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
            </nav>
        </aside>

        <main class="neo-main">
            <div class="neo-topbar">
                <div>
                    <h1><i class="fas fa-chart-bar"></i> Reports & Analytics</h1>
                    <p>// Attendance data visualization</p>
                </div>
                <div class="neo-topbar-actions">
                    <a href="/Admin/Dashboard" class="neo-btn"><i class="fas fa-arrow-left"></i> Back</a>
                </div>
            </div>

            <!-- Filter Section -->
            <div class="neo-card">
                <div class="neo-card-header">
                    <h3><i class="fas fa-filter"></i> Report Filters</h3>
                </div>
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="setReportType('all')">All Time</button>
                    <button class="tab-btn" onclick="setReportType('monthly')">Monthly</button>
                    <button class="tab-btn" onclick="setReportType('semester')">Semester</button>
                    <button class="tab-btn" onclick="setReportType('yearly')">Yearly</button>
                </div>
                <div class="filter-row">
                    <div id="monthlyFilters" class="filter-section">
                        <div class="neo-form-group" style="flex:1;"><label class="neo-label">Start Date</label><input type="date" id="startDate" class="neo-input"></div>
                        <div class="neo-form-group" style="flex:1;"><label class="neo-label">End Date</label><input type="date" id="endDate" class="neo-input"></div>
                    </div>
                    <div id="semesterFilters" class="filter-section">
                        <div class="neo-form-group" style="flex:1;"><label class="neo-label">Select Semester</label><select id="semesterSelect" class="neo-select"><option value="">-- Loading --</option></select></div>
                    </div>
                    <div id="yearlyFilters" class="filter-section">
                        <div class="neo-form-group" style="flex:1;"><label class="neo-label">Select Year</label><select id="yearSelect" class="neo-select"><option value="2026">2026</option><option value="2025">2025</option><option value="2024">2024</option></select></div>
                    </div>
                    <div style="flex: 0;">
                        <button class="neo-btn neo-btn-primary" onclick="applyFilters()"><i class="fas fa-search"></i> Apply Filters</button>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="neo-card" style="text-align: center; padding: 60px;">
                <i class="fas fa-spinner loading-spinner" style="font-size: 48px; color: #9333ea;"></i>
                <p style="margin-top: 20px; font-family: var(--font-mono);">Loading reports data...</p>
            </div>

            <!-- Statistics Cards -->
            <div id="statsContainer" class="neo-stats-grid" style="display: none;">
                <div class="neo-stat-card cyan"><div class="neo-stat-icon cyan"><i class="fas fa-clipboard-list"></i></div><div class="neo-stat-value" id="totalRecords">0</div><div class="neo-stat-label">Total Records</div></div>
                <div class="neo-stat-card green"><div class="neo-stat-icon green"><i class="fas fa-check-circle"></i></div><div class="neo-stat-value" id="presentCount">0</div><div class="neo-stat-label">Present</div></div>
                <div class="neo-stat-card orange"><div class="neo-stat-icon orange"><i class="fas fa-times-circle"></i></div><div class="neo-stat-value" id="absentCount">0</div><div class="neo-stat-label">Absent</div></div>
                <div class="neo-stat-card yellow"><div class="neo-stat-icon yellow"><i class="fas fa-calendar-minus"></i></div><div class="neo-stat-value" id="leaveCount">0</div><div class="neo-stat-label">On Leave</div></div>
                <div class="neo-stat-card purple"><div class="neo-stat-icon purple"><i class="fas fa-percentage"></i></div><div class="neo-stat-value" id="avgAttendance">0%</div><div class="neo-stat-label">Attendance Rate</div></div>
            </div>

            <!-- Charts Section -->
            <div id="chartsContainer" class="report-grid" style="display: none;">
                <div class="neo-card">
                    <div class="neo-card-header"><h3><i class="fas fa-chart-pie"></i> Attendance Distribution</h3></div>
                    <div class="chart-container"><canvas id="attendanceChart"></canvas></div>
                </div>
                <div class="neo-card">
                    <div class="neo-card-header"><h3><i class="fas fa-chart-line"></i> Monthly Trend</h3></div>
                    <div class="chart-container"><canvas id="trendChart"></canvas></div>
                </div>
            </div>

            <!-- Export Section -->
            <div class="neo-card">
                <div class="neo-card-header"><h3><i class="fas fa-download"></i> Export Reports</h3></div>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="neo-btn neo-btn-success" onclick="exportReport('csv')"><i class="fas fa-file-csv"></i> Export CSV</button>
                    <button class="neo-btn neo-btn-info" onclick="exportReport('pdf')"><i class="fas fa-file-pdf"></i> Export PDF</button>
                    <button class="neo-btn neo-btn-warning" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        let attendanceChart, trendChart;
        let currentReportType = 'all';

        window.onload = async function() {
            await loadSemesters();
            await loadReportsData();
        };

        function setReportType(type) {
            currentReportType = type;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('monthlyFilters').style.display = 'none';
            document.getElementById('semesterFilters').style.display = 'none';
            document.getElementById('yearlyFilters').style.display = 'none';
            if (type === 'monthly') document.getElementById('monthlyFilters').style.display = 'flex';
            else if (type === 'semester') document.getElementById('semesterFilters').style.display = 'flex';
            else if (type === 'yearly') document.getElementById('yearlyFilters').style.display = 'flex';
        }

        async function loadSemesters() {
            try {
                const response = await fetch('/Admin/GetSemestersList');
                const semesters = await response.json();
                const select = document.getElementById('semesterSelect');
                select.innerHTML = '<option value="">-- Select Semester --</option>';
                semesters.forEach(sem => { select.innerHTML += `<option value="${sem.semesterId}">${sem.name}</option>`; });
            } catch (error) { console.error('Error loading semesters:', error); }
        }

        async function applyFilters() { await loadReportsData(); }

        async function loadReportsData() {
            try {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('statsContainer').style.display = 'none';
                document.getElementById('chartsContainer').style.display = 'none';

                let url = '/Admin/GetFilteredReports?reportType=' + currentReportType;
                if (currentReportType === 'monthly') {
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    if (startDate && endDate) url += `&startDate=${startDate}&endDate=${endDate}`;
                } else if (currentReportType === 'semester') {
                    const semesterId = document.getElementById('semesterSelect').value;
                    if (semesterId) url += `&semesterId=${semesterId}`;
                } else if (currentReportType === 'yearly') {
                    const year = document.getElementById('yearSelect').value;
                    url += `&startDate=${year}-01-01`;
                }

                const response = await fetch(url);
                const data = await response.json();

                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('statsContainer').style.display = 'grid';
                document.getElementById('chartsContainer').style.display = 'grid';

                document.getElementById('totalRecords').textContent = data.totalRecords;
                document.getElementById('presentCount').textContent = data.presentCount;
                document.getElementById('absentCount').textContent = data.absentCount;
                document.getElementById('leaveCount').textContent = data.leaveCount;
                document.getElementById('avgAttendance').textContent = data.avgAttendance.toFixed(1) + '%';

                createAttendanceChart(data.presentCount, data.absentCount, data.leaveCount);
                createTrendChart(data.monthlyData || []);
            } catch (error) {
                console.error('Error loading reports:', error);
                document.getElementById('loadingState').innerHTML = '<i class="fas fa-exclamation-triangle" style="font-size:48px; color:#ef4444;"></i><p style="color:#ef4444; margin-top:20px;">Error loading reports</p>';
            }
        }

        function createAttendanceChart(present, absent, leave) {
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            if (attendanceChart) attendanceChart.destroy();
            attendanceChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: ['Present', 'Absent', 'Leave'], datasets: [{ data: [present, absent, leave], backgroundColor: ['#22c55e', '#ef4444', '#f97316'], borderWidth: 3, borderColor: '#000' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { family: "'Space Grotesk', sans-serif", weight: 'bold' } } } } }
            });
        }

        function createTrendChart(monthlyData) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            if (trendChart) trendChart.destroy();
            const labels = monthlyData.map(d => { const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; return months[d.month - 1] + ' ' + d.year; });
            const percentages = monthlyData.map(d => d.total > 0 ? (d.present * 100 / d.total).toFixed(1) : 0);
            trendChart = new Chart(ctx, {
                type: 'line',
                data: { labels: labels.length > 0 ? labels : ['No Data'], datasets: [{ label: 'Attendance %', data: percentages.length > 0 ? percentages : [0], borderColor: '#9333ea', backgroundColor: 'rgba(147, 51, 234, 0.1)', borderWidth: 3, tension: 0.3, fill: true }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { labels: { font: { family: "'Space Grotesk', sans-serif", weight: 'bold' } } } } }
            });
        }

        function exportReport(type) { alert(`Export as ${type.toUpperCase()} - Feature coming soon!`); }
    </script>
</body>
</html>

